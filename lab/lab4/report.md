#                                       编译原理第四次实验报告

​                                                                       201220187 孙赫彬

#### 一、功能

​	将实验三中得到的中间代码转换为MIPS32汇编代码，具体包括：

​			1. 指令选择

​			2. 寄存器选择

​			3. 栈管理

#### 二、实现思路

1. 寄存器管理

   32个寄存器用结构体表示，在结构体中存储相关信息，结构体如下所示：

   ```
   struct Reg
   {
       char* name;//寄存器的名字
       int free;//0代表寄存器空闲,1代表寄存器被变量占用
       OBJ_symList content;//指向占用寄存器的变量
       int pre_used_line;//上一次被使用该寄存器的代码的行号，用于寄存器的替换
       int can_free;//如果值为1，则代表该寄存器里面存的是不会再用临时变量，可以被替换
   }my_regs[32];
   ```

   另外设置结构体OBJ_symList_来记录变量的信息，当前函数中所有出现过的，并且之后有可能用到的变量，用该结构体表示，连成链表保存起来。

   ```
   typedef struct OBJ_symList_* OBJ_symList;
   struct OBJ_symList_{
       Operand op;
       int offset;//记录了在栈中位置距离$fp的偏移量，若不在栈中，则大于
       int reg;//=-1,not in reg
       OBJ_symList next;
   };
   OBJ_symList obj_list;
   ```

   我提供了三个函数来方便寄存器的管理，分别是clear_regs，save_regs和getReg，这些函数中操作的寄存器只有\$t0-\$t9和\$s0-\$s7，其他寄存器都又别的功能，所以不能用。

   clear_regs()函数是用来清空所有寄存器的，但是并不会将寄存器的内容存入栈中，而是直接暴力清空，所以只用于新进入一个函数时的清空操作。

   save_regs()函数也是用来清空所有寄存器的，但是在清空之前，会将寄存器中的内容，如果是之后可能用到的变量，则要先将该变量存入栈中，再清空寄存器。

   int getReg(Operand op)函数负责为变量获取一个寄存器，并返回该寄存器的编号。该函数首先遍历寄存器，看看该变量是否已经在寄存器中，若已经在寄存器中，则直接返回所在寄存器的编号。否则，就重新遍历寄存器，如果能找到空闲的或者里面的临时变量不会再用的寄存器，则将该变量存入这个寄存器并返回编号；如果找不到，那就选择上一次使用最远的寄存器，将里面的变量存入栈中，再将新变量存入这个寄存器并返回编号。

   这三个函数，就成为了支持**局部寄存器分配算法**的基础，使用变量时要先将变量存入寄存器，在使用期间，只需要改变寄存器内的值即可，直到基本块的结束，再将寄存器内变量的值存入栈中。

2. 栈管理

   每次进入函数之前，都将参数压栈，然后将\$ra和旧的\$fp的值压栈，再将\$fp指向当前\$sp的位置。要将变量存入栈中，则需要判断栈中是否已经为该变量开辟空间，若已经开辟，则直接存入，反之，需要将$sp减4，开辟空间，再存入。

   为了记录变量在栈中的位置，我定义了变量cur_offset，用来记录当前\$sp与\$fp的差值，每次对$sp进行修改时，都更新它的值。每次在栈中为变量开辟空间时，都将当前的cur_offset存在变量对应的结构体中，这样之后再访问该变量时，就可以在栈中找到它了。

3. 指令选择

   遍历实验3中的中间代码，每一句都根据实验指导中的`表11. 中间代码与MIPS32指令对应的一个示例` 进行翻译，遇到变量就调用getReg函数获取寄存器，每次跳转之前都调用save_regs函数保存寄存器内的信息。

#### 三、编译方法

使用makefile编译，输入命令`make`

#### 四、编译环境

1) GNU Linux Release: Ubuntu 20.04, kernel version 5.15.0-48-generic
2) GCC version 7.5.0
3) GNU Flex version 2.6.4
4) GNU Bison version 3.5.1